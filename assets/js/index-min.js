angular.module("devicechecker.directives",[]).directive("activeTable",function(){return{restrict:"A",link:function(c,b,a){if(angular.isString(a.activeTable)){b.dataTable({aoColumns:[{mData:"user"},{mData:"status"},{mData:"date"}],aaSorting:[[2,"desc"]]});c.$watchCollection("device.actual.history",function(d){b.dataTable().fnClearTable();b.dataTable().fnAddData(d)});if(c.device&&c.device.actual&&c.device.actual.history){b.dataTable().fnAddData(c.device.actual.history)}}}}});angular.module("device",["ui.bootstrap","firebase","devicechecker.directives"]).value("fbURL","https://devicetrack.firebaseio.com/").value("deviceBasePath","stock/").factory("time",function(){var b={};(function a(){b.now=new Date()}());return b}).controller("ListCtrl",["$rootScope","angularFireCollection","fbURL","deviceBasePath",function(a,c,d,b){a.stocks=c(new Firebase(d+b));window.stocks=a.stocks;a.fbURL=d}]).controller("DeviceCtrl",["$rootScope","$location","time","$routeParams","deviceBasePath",function(a,f,e,d,c){var b=a.stocks.getByName(d.groupId);if(b){this.actual=b[d.deviceId]}this.time=e;this.activeTab=$("ul.nav-tabs li.active");this.$routeParams=d;this.send=function(i,h){var k=this.actual,j=i.groupId+"/"+i.deviceId,g=new Firebase(a.fbURL+c+j),l={};g.once("value",function(s){var r=CryptoJS.MD5(k.password).toString(),q={user:k.user,status:"Checked-in",date:moment().format("YYYY-MM-DD hh:mm:ss a")},p,m=s.child("inUse").val(),n=s.child("lockPhrase").val(),o=s.child("user").val();if(!k.history){k.history=[]}else{k.history=s.child("history").val();p=k.history.length;if(p>=80){k.history=k.history.slice(p-79,p)}}if(m&&(o===k.user)){if(n!==r){h.$error.invalid=true;h.$valid=false;h.$invalid=true}else{h.$error.invalid=false;h.$valid=true;h.$invalid=false;k.password="";k.user="";k.lockPhrase="";k.history.push(q);k.inUse=false;l={inUse:false,user:"",password:"",lockPhrase:"",history:k.history}}}else{if(!m&&(n==="")&&(o==="")){q.status="Checked-out";k.inUse=true;k.lockPhrase=r;k.history.push(q);k.password="";l={inUse:true,user:k.user,password:"",lockPhrase:r,history:k.history}}}});g.update(l)};if(!this.actual){f.path("/")}}]).config(["$routeProvider",function(a){a.when("/:groupId/:deviceId",{controller:"DeviceCtrl",templateUrl:"/devicetracker/device.html",controllerAs:"device"}).otherwise({redirectTo:"/"})}]);