angular.module("devicechecker.directives",[]).directive("activeTable",function(){return{restrict:"A",link:function(c,b,a){if(angular.isString(a.activeTable)){b.dataTable({aoColumns:[{mData:"user"},{mData:"status"},{mData:"date"}],aaSorting:[[2,"desc"]]});c.$watchCollection("device.actual.history",function(d){b.dataTable().fnClearTable();b.dataTable().fnAddData(d)});if(c.device&&c.device.actual&&c.device.actual.history){b.dataTable().fnAddData(c.device.actual.history)}}}}});angular.module("device",["ui.bootstrap","firebase","devicechecker.directives"]).value("fbURL","https://devicetrack.firebaseio.com/").value("deviceBasePath","stock/").factory("time",function(){var b={};(function a(){b.now=new Date()}());return b}).controller("ListCtrl",["$rootScope","angularFireCollection","fbURL","deviceBasePath",function(a,c,d,b){a.stocks=c(new Firebase(d+b));window.stocks=a.stocks;a.fbURL=d}]).controller("DeviceCtrl",["$rootScope","time","$routeParams","deviceBasePath",function(a,e,d,c){var b=a.stocks.getByName(d.groupId);if(b){this.actual=b[d.deviceId]}this.time=e;this.activeTab=$("ul.nav-tabs li.active");this.$routeParams=d;this.send=function(g){var i=this.actual,h=g.groupId+"/"+g.deviceId,f=new Firebase(a.fbURL+c+h),j={};f.once("value",function(m){var l=CryptoJS.MD5(i.password).toString(),k={user:i.user,status:"Checked-in",date:moment().format("YYYY-MM-DD hh:mm:ss a")};if(!i.history){i.history=[]}else{i.history=m.child("history").val()}if(m.child("inUse").val()&&(m.child("lockPhrase").val()===l)&&(m.child("user").val()===i.user)){i.password="";i.user="";i.lockPhrase="";i.history.push(k);i.inUse=false;j={inUse:false,user:"",password:"",lockPhrase:"",history:i.history}}else{if(!m.child("inUse").val()&&(m.child("lockPhrase").val()==="")&&(m.child("user").val()==="")){k.status="Checked-out";i.inUse=true;i.lockPhrase=l;i.history.push(k);i.password="";j={inUse:true,user:i.user,password:"",lockPhrase:l,history:i.history}}}});f.update(j)}}]).config(["$routeProvider",function(a){a.when("/:groupId/:deviceId",{controller:"DeviceCtrl",templateUrl:"device.html",controllerAs:"device"}).otherwise({redirectTo:"/"})}]);